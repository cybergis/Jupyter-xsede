# summa3: a843a8c46484d47979f8cb8e48b82ef71a177894
# pysumma: e118139c64f7c4c4d00e7ec80da869a935637987

Bootstrap: docker
From: ubuntu:xenial
IncludeCmd: yes
%setup
    mkdir -p /code
    cp -r . $SINGULARITY_ROOTFS/code/
%post
    # Install only the packages that are needed
    apt-get update && \
    apt-get install -y --no-install-recommends \
    software-properties-common python-software-properties \
    ca-certificates \
    git \
    make \
    libnetcdff-dev \
    liblapack-dev \
    vim \
    wget \
    build-essential \
    nano

    # Install gfortran-6
    add-apt-repository ppa:ubuntu-toolchain-r/test -y \
    && apt-get update \
    && apt-get install -y --no-install-recommends gfortran-6 \
    && apt-get clean

    # Fetch tags and build summa
    export F_MASTER=/code
    export FC=gfortran
    export FC_EXE=gfortran
    export INCLUDES='-I/usr/include'
    export LIBRARIES='-L/usr/lib -lnetcdff -L/usr/lib -lblas -llapack'
    cd /code
    git fetch --tags && make -C build/ -f Makefile

    apt-get update &&\
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-py37_4.8.3-Linux-x86_64.sh -O ~/miniconda3.sh && \
    /bin/bash ~/miniconda3.sh -b -p /opt/conda && \
    rm ~/miniconda3.sh
    #Install Python packages for pySUMMA
    export PATH=/opt/conda/bin:$PATH
    conda config --add channels conda-forge
    # install dependencies for pysumma
    wget https://raw.githubusercontent.com/UW-Hydro/pysumma/master/environment.yml -O ~/pysumma_env.yml && \
    sed -i 's/- summa=3.0.0/#- summa=3.0.0/g' ~/pysumma_env.yml && \
    sed -i 's/pysumma/base/g' ~/pysumma_env.yml && \
    cat ~/pysumma_env.yml && \
    conda env update --name base -f ~/pysumma_env.yml
    pip install  git+https://github.com/UW-Hydro/pysumma.git@e118139c64f7c4c4d00e7ec80da869a935637987
    conda install -c conda-forge mpi4py=3.0.3
    

%environment
    export PATH=/opt/conda/bin:$PATH
    export F_MASTER=/code
    export FC=gfortran
    export FC_EXE=gfortran
%runscript
    exec python $@

